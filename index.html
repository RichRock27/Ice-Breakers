<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Icebreaker Experience: Director's Cut</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --brand: #c67c48;
      --brand-dark: #995a33;
      --gold: #ffd700;
      --curtain: #8b4513;
      --curtain-shadow: #5a2d0c;
    }

    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Segoe UI', sans-serif;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* THE STAGE */
    .stage-container {
      width: 100%;
      height: 100%;
      position: relative;
      background: radial-gradient(circle at 50% 30%, #3e1e0d 0%, #000 70%);
      perspective: 1200px;
      overflow: hidden;
    }

    /* CURTAINS */
    .curtain {
      position: absolute;
      top: 0;
      height: 100%;
      width: 50%;
      background: repeating-linear-gradient(90deg, var(--curtain), var(--curtain) 40px, var(--curtain-shadow) 60px, var(--curtain) 80px);
      box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.7);
      transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .curtain.left {
      left: 0;
      transform-origin: left;
      border-right: 4px solid var(--gold);
    }

    .curtain.right {
      right: 0;
      transform-origin: right;
      border-left: 4px solid var(--gold);
    }

    .stage-open .curtain.left {
      transform: translateX(-90%);
    }

    .stage-open .curtain.right {
      transform: translateX(90%);
    }

    /* CURTAIN LOGO */
    .curtain-logo {
      position: absolute;
      top: 40%;
      width: 100%;
      opacity: 0.9;
      mix-blend-mode: normal;
      pointer-events: none;
      display: flex;
      align-items: center;
    }

    .curtain.left .curtain-logo h1 {
      width: 100%;
      text-align: right;
      margin: 0;
      padding-right: 10px;
    }

    .curtain.right .curtain-logo h1 {
      width: 100%;
      text-align: left;
      margin: 0;
      padding-left: 10px;
    }

    /* MAIN CONTENT AREA BEHIND CURTAIN */
    .screen {
      position: absolute;
      inset: 10%;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      opacity: 0;
      transition: opacity 0.5s;
      padding: 40px;
      border: 8px solid var(--gold);
      z-index: 5;
    }

    .stage-open .screen {
      opacity: 1;
    }

    /* HOST AVATAR */
    .host-actor {
      position: absolute;
      bottom: -50px;
      left: 50%;
      width: 250px;
      height: 350px;
      transform: translateX(-50%) translateY(20px);
      transition: left 1.5s ease-in-out, transform 0.5s;
      z-index: 20;
      pointer-events: none;
    }

    .host-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
      animation: floatHost 3s ease-in-out infinite;
    }

    @keyframes floatHost {
      50% {
        transform: translateY(-10px);
      }
    }

    /* HOST POSITIONS */
    .host-actor.pos-left {
      left: 15%;
    }

    .host-actor.pos-right {
      left: 85%;
    }

    .host-actor.pos-center {
      left: 50%;
    }

    .host-actor.hidden {
      transform: translateX(-50%) translateY(400px);
    }

    /* SPEECH BUBBLE */
    .bubble {
      position: absolute;
      bottom: 320px;
      left: 50%;
      transform: translateX(-50%) scale(0);
      background: #fff;
      color: #000;
      padding: 20px 30px;
      border-radius: 30px;
      font-size: 20px;
      font-weight: 600;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 2px solid var(--brand);
      z-index: 25;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .bubble::after {
      content: '';
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 15px 15px 0;
      border-style: solid;
      border-color: #fff transparent transparent;
    }

    .bubble.show {
      transform: translateX(-50%) scale(1);
    }

    /* CONTROLS / INTERACTIVE UI */
    .ui-layer {
      position: absolute;
      inset: 0;
      z-index: 30;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .btn {
      pointer-events: auto;
      cursor: pointer;
      padding: 15px 40px;
      font-size: 22px;
      font-weight: bold;
      color: white;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      border: none;
      border-radius: 50px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s;
      margin-top: 20px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .btn.visible {
      transform: scale(1);
      opacity: 1;
    }

    .btn:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
      box-shadow: 0 0 20px var(--gold);
    }

    .btn-dod {
      background: linear-gradient(135deg, #4b0082, #8a2be2);
      box-shadow: 0 0 30px rgba(138, 43, 226, 0.6);
      font-size: 28px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* PARTICIPANT DISPLAY */
    .participant-big {
      font-size: 80px;
      font-weight: 900;
      color: var(--brand-dark);
      text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transform: scale(0.8);
      transition: 0.5s;
    }

    .participant-big.show {
      opacity: 1;
      transform: scale(1);
    }

    /* DIE OF DESTINY 3D */
    .die-container {
      width: 150px;
      height: 150px;
      perspective: 600px;
      display: none;
      margin-top: 30px;
    }

    .die-container.active {
      display: block;
    }

    .die {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transform: rotateX(0) rotateY(0);
    }

    .die.rolling {
      animation: rollDie 1s cubic-bezier(0.1, 0.7, 0.1, 1) infinite;
    }

    .face {
      position: absolute;
      width: 150px;
      height: 150px;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #ccc;
      border-radius: 20px;
      font-size: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.1);
      backface-visibility: hidden;
      font-weight: bold;
      color: #333;
    }

    .f1 {
      transform: rotateY(0deg) translateZ(75px);
    }

    .f2 {
      transform: rotateY(90deg) translateZ(75px);
    }

    .f3 {
      transform: rotateY(180deg) translateZ(75px);
    }

    .f4 {
      transform: rotateY(-90deg) translateZ(75px);
    }

    .f5 {
      transform: rotateX(90deg) translateZ(75px);
    }

    .f6 {
      transform: rotateX(-90deg) translateZ(75px);
    }

    @keyframes rollDie {
      0% {
        transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);
      }

      25% {
        transform: rotateX(180deg) rotateY(90deg) rotateZ(45deg);
      }

      50% {
        transform: rotateX(360deg) rotateY(180deg) rotateZ(90deg);
      }

      75% {
        transform: rotateX(540deg) rotateY(270deg) rotateZ(135deg);
      }

      100% {
        transform: rotateX(720deg) rotateY(360deg) rotateZ(180deg);
      }
    }

    /* QUESTION CARD */
    .q-card {
      padding: 40px;
    }

    .q-num {
      font-size: 24px;
      color: var(--gold);
      font-weight: bold;
      background: #000;
      padding: 5px 15px;
      border-radius: 20px;
      display: inline-block;
      margin-bottom: 20px;
    }

    .q-text {
      font-size: 40px;
      font-weight: bold;
      color: #222;
      margin-bottom: 30px;
      line-height: 1.3;
    }

    /* CHOICE PANEL */
    .choice-panel {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .choice-panel.active {
      display: flex;
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      opacity: 0;
      transform: translateY(20px);
      transition: 0.5s;
      pointer-events: auto;
    }

    .input-wrapper.show {
      opacity: 1;
      transform: translateY(0);
    }

    input.num-in {
      padding: 15px;
      font-size: 20px;
      border-radius: 10px;
      border: 2px solid #ccc;
      width: 100px;
      text-align: center;
    }

    /* SOUND TOGGLE */
    .sound-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 100;
      font-size: 30px;
      cursor: pointer;
      filter: drop-shadow(0 2px 4px #000);
      opacity: 0.7;
    }

    /* DECOYFACES */
    .face.decoy {
      color: #8a2be2;
      font-size: 40px;
    }
  </style>
</head>

<body>
  <div class="sound-btn" onclick="toggleSound()">ðŸ”Š</div>

  <div class="stage-container" id="stage">
    <!-- CURTAINS -->
    <div class="curtain left" id="cLeft">
      <div class="curtain-logo">
        <h1 style="font-size: 60px; color: var(--gold); text-shadow: 0 4px 10px rgba(0,0,0,0.5);">PROPERTY</h1>
      </div>
    </div>
    <div class="curtain right" id="cRight">
      <div class="curtain-logo">
        <h1 style="font-size: 60px; color: var(--gold); text-shadow: 0 4px 10px rgba(0,0,0,0.5);">ALLIANCE</h1>
      </div>
    </div>

    <!-- SCREEN (Behind Curtains) -->
    <div class="screen" id="screen">
      <div class="participant-big" id="partDisplay">?</div>

      <!-- CHOICE PANEL -->
      <div class="choice-panel" id="choicePanel">
        <button class="btn btn-dod" id="btnDod" onclick="chooseDOD()">
          <span>ðŸŽ²</span> DIE OF DESTINY
        </button>

        <div style="color:#aaa; margin: 10px;">â€” OR â€”</div>

        <div class="input-wrapper show">
          <input type="number" id="manualNum" class="num-in" placeholder="#" min="1" max="200">
          <button class="btn" style="transform:scale(1); opacity:1; padding: 10px 20px; margin:0;"
            onclick="chooseManual()">GO</button>
        </div>
      </div>

      <!-- DIE -->
      <div class="die-container" id="dieCont">
        <div class="die" id="theDie">
          <div class="face f1">?</div>
          <div class="face f2 decoy">ðŸ’©</div>
          <div class="face f3">12</div>
          <div class="face f4 decoy">ðŸ”¥</div>
          <div class="face f5">88</div>
          <div class="face f6 decoy">ðŸ¦„</div>
        </div>
      </div>

      <!-- FINAL QUESTION -->
      <div class="q-card" id="finalQ" style="display:none;">
        <div class="q-num" id="qNumBadge">#--</div>
        <div class="q-text" id="qTextView"></div>
        <button class="btn visible" onclick="resetGame()">Start Over ðŸ”„</button>
      </div>
    </div>

    <!-- HOST & BUBBLE -->
    <div class="bubble" id="bubble"></div>
    <div class="host-actor hidden" id="host">
      <!-- SVG Placeholder for Host (Rich's Description) -->
      <svg class="host-img" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg">
        <!-- Body -->
        <path d="M50 140 Q 100 320 150 140 L 140 300 L 60 300 Z" fill="#dd8800" />
        <!-- Floral Shirt Pattern -->
        <circle cx="80" cy="180" r="10" fill="#cc5500" opacity="0.6" />
        <circle cx="120" cy="220" r="12" fill="#552200" opacity="0.6" />
        <path d="M50 140 C 30 140, 20 200, 30 250" stroke="black" stroke-width="2" fill="none" />
        <path d="M150 140 C 170 140, 180 200, 170 250" stroke="black" stroke-width="2" fill="none" />
        <!-- Head -->
        <ellipse cx="100" cy="90" rx="45" ry="55" fill="#8d5524" /> <!-- Caramel Skin -->
        <!-- Beard/Goatee -->
        <path d="M85 130 Q 100 160 115 130 L 100 135 Z" fill="#111" />
        <rect x="58" y="80" width="10" height="30" fill="#111" /> <!-- Sideburn L -->
        <rect x="132" y="80" width="10" height="30" fill="#111" /> <!-- Sideburn R -->
        <!-- Glasses -->
        <g fill="none" stroke="#4a3c31" stroke-width="4">
          <circle cx="82" cy="85" r="14" />
          <circle cx="118" cy="85" r="14" />
          <line x1="96" y1="85" x2="104" y2="85" />
        </g>
        <!-- Eyes/Mouth -->
        <circle cx="82" cy="85" r="3" fill="black" />
        <circle cx="118" cy="85" r="3" fill="black" />
        <path d="M 85 115 Q 100 125 115 115" stroke="black" stroke-width="2" fill="none" />
      </svg>
    </div>

    <!-- Intro Button -->
    <div class="ui-layer">
      <button class="btn" id="startBtn" onclick="startShow()">ðŸŽ¤ START SHOW</button>
    </div>
  </div>

  <script>
    // === SOUND ENGINE ===
    let audioCtx = null;
    let soundOn = true;
    let announcerVoice = null;

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        // Load voices
        const voices = window.speechSynthesis.getVoices();
        announcerVoice = voices.find(v => v.lang.includes('en') && v.name.includes('Male')) || voices[0];
      }
    }

    function toggleSound() { soundOn = !soundOn; document.querySelector('.sound-btn').style.opacity = soundOn ? 1 : 0.3; }

    function playTone(freq, type, duration, vol = 0.1) {
      if (!soundOn || !audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type; osc.frequency.value = freq;
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start();
      gain.gain.setValueAtTime(vol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      osc.stop(audioCtx.currentTime + duration);
    }

    function playNoise(duration) {
      if (!soundOn || !audioCtx) return;
      const bufferSize = audioCtx.sampleRate * duration;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }
      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;
      const gain = audioCtx.createGain();
      gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      noise.connect(gain);
      gain.connect(audioCtx.destination);
      noise.start();
    }

    function playJingle() {
      if (!soundOn) return; initAudio();
      // Simple major scale climb "Da-da-da-DAAA!"
      let time = 0;
      [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
        setTimeout(() => playTone(f, 'square', 0.2, 0.1), i * 150);
      });
      setTimeout(() => playTone(880, 'sine', 0.4, 0.1), 600); // Harmony
    }

    function playApplause() {
      if (!soundOn) return;
      // Burst of noise claps
      for (let i = 0; i < 15; i++) {
        setTimeout(() => playNoise(0.2 + Math.random() * 0.3), i * 100);
      }
    }

    function playRollSound() {
      if (!soundOn) return; initAudio();
      let count = 0;
      const roll = setInterval(() => {
        playTone(200 + Math.random() * 200, 'square', 0.05);
        count++; if (count > 15) clearInterval(roll);
      }, 80);
    }

    function playSpeechSound() {
      if (!soundOn) return; initAudio();
      playTone(300 + Math.random() * 100, 'sine', 0.05);
    }

    // === TEXT TO SPEECH ANNOUNCER ===
    function announcerSay(text) {
      if (!soundOn) return new Promise(r => setTimeout(r, 2000));
      return new Promise(resolve => {
        const u = new SpeechSynthesisUtterance(text);
        if (announcerVoice) u.voice = announcerVoice;
        u.rate = 1.1;
        u.pitch = 0.9;
        u.volume = 1;
        u.onend = resolve;
        window.speechSynthesis.speak(u);
      });
    }

    // === ACTOR SYSTEM ===
    const host = document.getElementById('host');
    const bubble = document.getElementById('bubble');

    function moveHost(posClass) {
      host.className = 'host-actor ' + posClass;
    }

    async function speak(text, duration = 2000) {
      bubble.textContent = '';
      bubble.classList.add('show');
      const chars = text.split('');
      for (let c of chars) {
        bubble.textContent += c;
        if (c !== ' ') playSpeechSound();
        await wait(70);
      }
      await wait(duration);
      bubble.classList.remove('show');
    }

    // === GAME STATE ===
    const employeeList = ['Rich', 'Zack', 'Lulu', 'Lauren', 'Brad', 'Chase', 'Matt'];
    let currentParticipant = "";

    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function startShow() {
      initAudio();
      const btn = document.getElementById('startBtn');
      btn.style.opacity = '0';
      await wait(300);
      btn.style.display = 'none';

      // ANNOUNCER INTRO
      playJingle();
      await wait(1000);

      // Voice + Subtitles? We'll just use voice and wait
      await announcerSay("Ladies and Gentlemen... thank you for joining us for another exciting edition of Ice Breakers!");
      await wait(500);

      await announcerSay("And here is your host...");
      await wait(800);
      await announcerSay("Richie 'The Closer' Green!");

      // ACT 1: Host Enters
      moveHost('pos-center');
      playApplause();
      await wait(2000); // Soak in applause

      await speak("Thank you! Thank you!", 1500);
      await speak("Let's see who our lucky participant is today...", 1500);

      // Indicate curtain
      moveHost('pos-left');
      await wait(1000);

      // ACT 2: Reveal Participant
      document.getElementById('stage').classList.add('stage-open');
      playJingle(); // Mini fanfare
      await shuffleParticipant();

      // ACT 3: The Choice
      moveHost('pos-right');
      await wait(500);
      await speak(`Alright ${currentParticipant}, it's your big day!`, 2000);
      await speak("You are Top Dog!", 1500);
      await speak("Choose a number... OR roll the Die of Destiny!", 2000);

      // Show Controls
      document.getElementById('choicePanel').classList.add('active');
      document.getElementById('btnDod').classList.add('visible');
    }

    async function shuffleParticipant() {
      const pDisp = document.getElementById('partDisplay');
      pDisp.classList.add('show');

      // Slower shuffle (~50% speed)
      for (let i = 0; i < 15; i++) {
        pDisp.textContent = employeeList[Math.floor(Math.random() * employeeList.length)];
        playTone(800, 'sine', 0.05);
        await wait(150 + (i * 30)); // Getting slower
      }

      currentParticipant = employeeList[Math.floor(Math.random() * employeeList.length)];
      pDisp.textContent = currentParticipant;
      pDisp.style.color = '#e23a2b';
      pDisp.style.transform = "scale(1.2)";
      playFanfare();

      // Confetti
      confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
      await wait(1000);
    }

    // === CHOICE HANDLERS ===

    async function chooseManual() {
      const val = document.getElementById('manualNum').value;
      if (!val) return;

      // Hide controls
      document.getElementById('choicePanel').classList.remove('active');

      await speak(`You chose number ${val}...`, 1500);
      await speak("I wouldn't have picked that, but you be you.", 2000);
      await speak("Let's see what you got!", 1000);

      google.script.run.withSuccessHandler(revealFinal).showManualQuestion(parseInt(val, 10));
    }

    async function chooseDOD() {
      document.getElementById('choicePanel').classList.remove('active');
      moveHost('pos-center');

      // ACT 4: The Roll
      await speak("You went with the Die of Destiny!", 1500);
      await speak("Like the rock said to the hill... Let's ROLL!", 1500);

      // Show Die
      const dieCont = document.getElementById('dieCont');
      const theDie = document.getElementById('theDie');
      document.getElementById('partDisplay').style.display = 'none'; // Hide name temporarily
      dieCont.classList.add('active');
      theDie.classList.add('rolling');
      playRollSound();

      await wait(2500); // Rolling time

      // Stop Roll
      theDie.classList.remove('rolling');

      // Fetch Result
      google.script.run.withSuccessHandler(async (res) => {
        // Update Die Face to result
        theDie.style.transform = "rotateX(0) rotateY(0)";
        document.querySelector('.f1').textContent = res.number;
        playFanfare();

        await wait(1000);
        await speak(`Oh man, I was hoping for the Unicorn...`, 2000);
        await speak(`But you got number ${res.number}.`, 1500);
        await speak(`If it's a lame question, it's your fault!`, 2000);

        dieCont.classList.remove('active'); // Hide Die
        revealFinal(res);

      }).pickRandomIcebreaker();
    }

    async function revealFinal(result) {
      moveHost('pos-left'); // Get out of way

      const qCard = document.getElementById('finalQ');
      const qBadge = document.getElementById('qNumBadge');
      const qText = document.getElementById('qTextView');

      document.getElementById('partDisplay').style.display = 'none';
      qCard.style.display = 'block';

      qBadge.textContent = "#" + result.number;

      // Typewriter Question
      qText.textContent = "";
      const words = result.question.split(" ");
      for (let w of words) {
        if (w) qText.textContent += w + " ";
        await wait(50);
      }

      confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
      await wait(2000);
      moveHost('pos-center');
      await speak("Thank you! See you next week!", 3000);
    }

    function resetGame() {
      // Soft reset
      document.getElementById('finalQ').style.display = 'none';
      document.getElementById('stage').classList.remove('stage-open');
      moveHost('hidden');
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('startBtn').style.opacity = '1';
    }
  </script>
</body>

</html>